<!DOCTYPE html>
<html>

<head>
    <title>Simple login form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    </style>
    <script>
        var top_prob_min = 0.05;
        var alertTTLinMs = 3000;
        
        function softmax(classes, top_n) {
            expons = [];
            for (let i = 0; i < classes.length; i++) {
                expons[i] = Math.exp(classes[i][1]);
            }

            expon_sum = expons.reduce((partialSum, a) => partialSum + a, 0);

            result = [];
            other_prob = 1;
            let i = 0
            for (; i < top_n; i++) {
                prob = expons[i] / expon_sum;
                if (prob <= top_prob_min) {
                    break;
                }
                other_prob = other_prob - prob
                result[i] = [classes[i][0], Math.round(prob * 100)];
            }

            if (other_prob > top_prob_min) {
                result[i] = ["other", Math.round(other_prob * 100)];
            }

            return result;
        }

        function evaluateColorClass(prob) {
            if (prob > 70) {
                return "bg-success"
            } else if(prob > 50) {
                return "bg-info"
            } else if(prob > 20) {
                return "bg-warning"
            } else {
                return "bg-danger"
            }
        }

        async function disapearAlert() {
            await new Promise(resolve => setTimeout(resolve, alertTTLinMs));
            document.getElementById("alert").innerHTML = null;
            document.getElementById("alert").style.display = "none";
        }

        async function showAlert(message, type) {
            var alertBanner = document.getElementById("alert");
            alertBanner.setAttribute('class', 'alert-dismissible fade show alert ' + type);
            alertBanner.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            alertBanner.style.display = 'block';

            await disapearAlert();
        }

        function createPercentageElement(class_name, prob) {
            var perEle = document.createElement("div");
            perEle.setAttribute('class', 'progress');
            perEle.setAttribute('role', 'progressbar');
            perEle.setAttribute('aria-valuenow', prob);
            perEle.setAttribute('aria-valuemax', 100);
            perEle.setAttribute('aria-valuemin', 0);
            perEle.setAttribute('id', class_name);

            var child = document.createElement("div");
            child.setAttribute('class', 'progress-bar ' + evaluateColorClass(prob))
            child.setAttribute('style', 'width: ' + prob +'%');
            child.innerText = class_name.toUpperCase() + " " + prob + "%";

            perEle.appendChild(child);

            return perEle;
        }

        function updateImage() {
            var urlString = document.getElementById("url").value;
            var targetImage = document.getElementById("image_intended");
            var predictions = document.getElementById("predictions");

            if (urlString == null || urlString == "") {
                targetImage.style.display = 'none';
                predictions.style.display = 'none';
                return;
            }

            try {
                var url = new URL(urlString);
                targetImage.style.display = 'inline';
                targetImage.setAttribute('src', url.href);

            } catch (err) {
                targetImage.style.display = 'none';
                predictions.style.display = 'none';
                showAlert("Invalid url", "alert-warning");
            }
        }

        function evaluateImage() {
            var urlString = document.getElementById("url").value;
            try {
                var url = new URL(urlString);
            } catch (err) {
                showAlert("Invalid url", "alert-warning");
                return;
            }
            fetch("https://ml.thebendu.link/clothing/predict", {
                method: "POST",
                body: JSON.stringify(
                    { url: url.href }
                ),
                headers: {
                    "Content-type": "application/json",
                    "Origin": "Demo-page",
                }
            })
                .then((response) => response.json())
                .then((json) => {
                    if ("errorMessage" in json) {
                        showAlert("Error in backend", "alert-danger");
                        return;
                    }
                    var classes = Object.keys(json).map(function (key) {
                        return [key, json[key]];
                    });
                    classes.sort(function (first, second) {
                        return second[1] - first[1];
                    });

                    top_classes = softmax(classes, 3);

                    var predictions = document.getElementById("predictions");
                    predictions.innerHTML = null;
                    for (i in top_classes) {
                        var divEle = document.createElement("div");
                        divEle.setAttribute('class', 'list-group-item');
                        divEle.appendChild(createPercentageElement(top_classes[i][0], top_classes[i][1]));

                        predictions.append(divEle);
                    }
                    predictions.style.display = 'inline';
                });
        }
    </script>
</head>

<body class="text-center">
    <h1>Clothing classifier</h1>

    <div role="alert" id="alert" style="display: none;"></div>

    <div class="input-group mb-3">
        <input type="url" class="form-control" placeholder="Image url" aria-label="Recipient's username"
            aria-describedby="button-addon2" onkeyup="updateImage()" id="url" required>
        <button class="btn btn-primary btn-lg" type="button" id="button-addon2" onclick="evaluateImage()">Submit</button>
    </div>

    <div class="text-center">
        <div id="predictions" class="list-group" style="display: none;height: 100px;"></div>
        <img id="image_intended" class="img-thumbnail" src="" style="display: none; align-items: center;height: 300px;">
    </div>
</body>

</html>